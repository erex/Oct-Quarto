---
title: Tutorial--analysis of stratified surveys
author: Centre for Research into Ecological and Environmental Modelling <br> **University of St Andrews**
date: "`r Sys.Date()`"
webr:
    packages: ['Distance']
filters: 
  - webr
---

```{r}
#| label = "setup",
#| include = FALSE,
#| message = FALSE
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
<img src=https://images.unsplash.com/photo-1603693786247-d70f78921a94?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=1489&q=80 width=400 height=200 style="float:right">

<p style="text-align:right font-size:80%"><span>Photo by <a href="https://unsplash.com/@nzrhan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Rowan Simpson</a> on <a href="https://unsplash.com/s/photos/minke-whale?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span> </p>


## Exercise 7 -- Analysis of stratified surveys

This set of questions is completely about the practicalities of interpreting output from `ds`.  It is far too easy to be beguiled by the rafts of output generated by a distance sampling analysis; we often just look at the estimated density or abundance and scurry along--particularly if the data are not your own.

Closely examine the results from this particular analysis, where the strata are analysed separately (distinct detection functions).  Recall the reason strata were introduced with this data set is because the southern portion of the study area (Southern Ocean) likely possessed a richer food source, hence there was a belief that there would be higher minke whale densities in the south than in the north.  Let's examine the output to see if this belief was supported by the data


```{webr-r}
#| label: complete-strat
#| context: output
#| message: false
data(minke)
minke.trunc <- 1.5
minke.S <- minke[minke$Region.Label=="South", ]
minke.df.S.strat <- ds(minke.S, truncation=minke.trunc, key="hr", adjustment=NULL)
summary(minke.df.S.strat)
minke.df.N.strat <- ds(minke[minke$Region.Label=="North", ],
                       truncation=minke.trunc, key="hr", adjustment=NULL)
summary(minke.df.N.strat)
```

### Answer these questions by examining at the output above

Before answering the questions, you'll need to orient yourself to the order in which the stratum results are presented.  *Hint*:  the stratum label appears in each piece of output.

```{r}
#| label: minke-choice
#| echo: false

minke_choices <- c("detectability differs between strata",
                   "whales from the southern stratum vacation in the northern stratum",
                   answer="the greater area of the northern stratum compensates for the low whale density",
                   "density is actually the reciprocal of abundance, a mathematical paradox")
```

::: {.webex-check .webex-box}

- How many times larger (geographically) is the northern stratum compared to the southern stratum? (to the nearest 0.5) `r fitb(7.5)`
- How many times larger is the estimated abundance in the northern stratum, compared to the south? (to the nearest 0.5) `r fitb(2.0)`
- Explain the paradox how can the southern stratum have a higher density but lower abundance of minke whales? `r longmcq(minke_choices)`

:::{.callout-note collapse=false appearance='default' icon=true}
## Comments about minke stratified analysis
- It is common for high quality habitat to be more scarce than low quality habitat.
- This serves as a lesson for future survey design:
  - do not design a survey such that all survey effort is allocated toward sampling the high quality habitat where you think most animals reside.  It might be the case that the lower quality habitat actually contains most of your study animals.

:::

:::

### About the possible difference in detectability

You can see that the estimate of $\hat{P}_a$ is different for the two strata.  But examine the output to find the estimates of the scale parameter $\hat{\sigma}$ for the two strata.  Notice they both appear to be negative.  Use the code below to convert those estimates of  $\hat{\sigma}$ into biologically interpretable quantities.  Enter values with 2 decimal places.

```{webr-r}
#| label: sigma
scale.intercept.south <- ___
scale.intercept.north <- ___
est.sigma.south <- exp(scale.intercept.south)
est.sigma.north <- exp(scale.intercept.north)
print(paste("South sigma=", est.sigma.south, "North sigma=", est.sigma.north))
```

```{r}
#| label: sig_choices
#| echo: false

sig_choices <- c(answer="larger estimate of sigma in the north implies better visibility in the north",
                 "larger estimate of sigma in the south suggests better visibility in the south",
                 "smaller estimate of sigma in the south implies better visibility in the south")
```

- With your knowledge of $\hat{\sigma}$ for each stratum, describe the visibility in the northern vs southern strata. `r longmcq(sig_choices)`

`r hide("Click here for a hint")`
Weather conditions are poorer in the south which is closer to the ice edge.
`r unhide()`

## Statistical difference in density between strata supplement

It is trivially easy to calculate the difference between two density estimates.  The messy part is comparing the magnitude of that difference against the uncertainty in that difference (ratio of signal (difference) to noise (uncertainty)).  This signal-to-noise ratio is measured by the traditional *t*-test, with the numerator being the signal (difference) while the denominator is a measure of noise (standard error of the estimated difference).

The challenge is to estimate the variance of the  difference in estimated density estimates.  The variance of a difference is the sum of variances in the two estimates when those estimates are independent; which they are when the density estimates are independently computed.  The calculation is more tricky when the two density estimates share a common detection function; the estimates are no longer independent.  That is why there are two different formulas for computing the test statistic for estimated density differences, and the function that computes the test statistic can cope with the two situation.

```{r}
#| label: difference
#| echo: false
#| eval: false

whales <- read.csv("https://raw.githubusercontent.com/erex/Oct-Quarto/master/Pr7/stratify_examp.csv")
hazard.pooled <- ds(data=whales, key="hr", truncation = 1.5)
ideal.hr <- ds(data=whales[whales$Region.Label=="Ideal",], key="hr", truncation=1.5)
marginal.hr <- ds(data=whales[whales$Region.Label=="Marginal",], key="hr", truncation=1.5)
download.file("https://github.com/erex/Oct-Quarto/blob/main/Pr7/density.difference.ds.r?raw=TRUE", "diff_fn.r")
source("diff_fn.r")
# downloader::source_url("https://github.com/erex/Oct-Quarto/blob/main/Pr7/density.difference.ds.r?raw=TRUE")
density.difference.ds(hazard.pooled)
density.difference.ds(ideal.hr, marginal.hr)
```

<pre>
> density.difference.ds(hazard.pooled)
  n.detect  cv.ER line.length n.transects group.size group.size.cv
1       39 0.2323         484          13     2.1538        0.1397
2       49 0.3724        1370          12     2.3265        0.2303
  nparm.detect  D.hat D.hat.cv     f0   f0cv
1            2 0.0929   0.2916 1.0711 0.1073
2            2 0.0446   0.4508 1.0711 0.1073
  D1.minus.D2 SE.difference t.statistic df.t.stat P.value     LCB    UCB
1      0.0484        0.0402      1.2048   49.2919   0.234 -0.0323 0.1291

> density.difference.ds(ideal.hr, marginal.hr)
  n.detect  cv.ER line.length n.transects group.size group.size.cv
1       39 0.2323         484          13     2.1538        0.1397
2       49 0.3724        1370          12     2.3265        0.2303
  nparm.detect  D.hat D.hat.cv     f0   f0cv
1            2 0.1167   0.3182 1.3450 0.1338
2            2 0.0365   0.4451 0.8781 0.1315
  D1.minus.D2 SE.difference t.statistic df.t.stat P.value     LCB    UCB
1      0.0802        0.0405      1.9779   27.6636   0.058 -0.0029 0.1633

</pre>



```{r}
#| label: diff_choices
#| echo: false

dif_ch1 <- c("estimated difference in density is larger when separate detection functions are fitted ",
              answer="number of detections is larger (perhaps sufficient) only when the two strata are combined")
dif_ch2 <- c("pooled detection functions reduce encounter rate variability",
             "encounter rate variability depends upon weather conditions",
             answer="encounter rate variability is always computed stratum-by-stratum")
dif_ch3 <- c("cv(encounter rate) is half cv(detection function)",
             "cv(encounter rate) roughly equal cv(detection function)",
             answer="cv(encounter rate) is double cv(detection function)")
dif_ch4 <- c("greater variability in encounter rate",
             "greater uncertainty in detection function",
             "improved precision in density estimate from pooled analysis",
             answer="expanded difference in the stratum-specific density estimates",
             "loss of degrees of freedom in the test statistic")
```

::: {.webex-check .webex-box}

- Why does the CV(detection function) increase when separate detection functions are fitted to each stratum? `r longmcq(dif_ch1)`
- Why does the CV(encounter rate) **not** increase when separate detection functions are fitted to each stratum? `r longmcq(dif_ch2)`
- What is the relative magnitude of CV(detection function) to CV(encounter rate) for either pooled or separate analyses? `r longmcq(dif_ch3)`
- What are contributing factors causing the significance value of the independent differences to be smaller (0.058) than the significance of the pooled analysis (0.234)? `r longmcq(dif_ch4)`

:::