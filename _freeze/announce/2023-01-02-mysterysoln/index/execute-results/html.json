{
  "hash": "d02d6fc8ba5a0ea0719b36d9f8169d5c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Solution to mystery analysis\ndescription: Remember, the most important aspect of this exercise is the workflow that you followed, the decisions you made and the support (evidence) used to support those decisions.\nauthor: \n  - name: Eric Rexstad\ndate: 02-28-2025\nimage: https://images.unsplash.com/photo-1443521156453-f82c842b6e7f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxjb2xsZWN0aW9uLXBhZ2V8NjB8NDcxMTQ0NHx8ZW58MHx8fHw%3D&auto=format&fit=crop&w=500&q=60\ndraft: false\n---\n\n\n\n\n\n:::{.callout-tip}\n# Demonstration\n\nStart-to-finish analysis of mystery data set\n:::\n\n# Data import\n\nNo drama to bring the labelled data frame into our **R** session.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydata <- read.csv(\"mystery.csv\")\n```\n:::\n\n\n\n# Exploratory data analysis\n\nNumber of strata, number of transects, number of detections, detections by sex\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Num strata= \", length(unique(mydata$Region.Label)))\ncat(\"\\nNum transects= \", length(unique(mydata$Sample.Label)))\ncat(\"\\nNum detects= \", sum(!is.na(mydata$distance)), \"\\n\")\ntable(mydata$sex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNum strata=  1\nNum transects=  12\nNum detects=  43 \n\nfemale   male \n     4     39 \n```\n\n\n:::\n:::\n\n\n\n# Distance distribution\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(mydata$distance, main=\"All detections\", breaks=seq(0,80,length=17),\n     xlab=\"Perpendicular distances (m)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/disdis-1.png){width=672}\n:::\n\n```{.r .cell-code}\nvioplot(mydata$distance[mydata$sex==\"male\"],\n        mydata$distance[mydata$sex==\"female\"])\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/disdis-2.png){width=672}\n:::\n:::\n\n\n\n# Truncation decision\n\n:::{.callout-hint}\n# A *rule of thumb* (Lecture 2, slide 21)\n\n> Can also use estimated values of g(x) from fitted model as truncation criterion; truncate at w when g(w)=0.15\n\n:::\n\nI'm reasonably content to stick with this rule of thumb, could slice out one more data point, if I truncated at 50m.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmyunits <- convert_units(\"meter\", \"kilometer\", \"square kilometer\")\nfirst <- ds(mydata, convert_units = myunits)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(first, breaks=seq(0,80,length=17))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSpecified endpoints > 79; values reset.\n```\n\n\n:::\n\n```{.r .cell-code}\nabline(h=0.15, col=\"red\", lty=3)\ntext(x=50, y=0.2, \"Pr(detect)=0.15\", cex=.8)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plottrunc-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntruncate <- 50\n```\n:::\n\n\n\n# Key function decision\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunicos <- ds(mydata, key=\"unif\", adj=\"cos\", truncation = truncate, convert_units = myunits)\nhn <- ds(mydata, key=\"hn\", adj=\"cos\", truncation = truncate, convert_units = myunits)\nhr <- ds(mydata, key=\"hr\", adj=\"cos\", truncation = truncate, convert_units = myunits)\n```\n:::\n\n\n\nNotice, adjustment terms did not survive the \"within key function family\" selection.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(summarize_ds_models(unicos, hn, hr, output=\"plain\"), digits=3, row.names = FALSE,\n                    caption=\"Key function models at 50m: do they fit?\")  %>%\n      kable_styling(full_width = F) %>%\n      column_spec(4, background=\"yellow\", width=\"8em\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Key function models at 50m: do they fit?</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:left;\"> Key function </th>\n   <th style=\"text-align:left;\"> Formula </th>\n   <th style=\"text-align:right;\"> C-vM $p$-value </th>\n   <th style=\"text-align:right;\"> Average detectability </th>\n   <th style=\"text-align:right;\"> se(Average detectability) </th>\n   <th style=\"text-align:right;\"> Delta AIC </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> hn </td>\n   <td style=\"text-align:left;\"> Half-normal </td>\n   <td style=\"text-align:left;\"> ~1 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.683 </td>\n   <td style=\"text-align:right;\"> 0.638 </td>\n   <td style=\"text-align:right;\"> 0.091 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> unicos </td>\n   <td style=\"text-align:left;\"> Uniform with cosine adjustment term of order 1 </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.706 </td>\n   <td style=\"text-align:right;\"> 0.624 </td>\n   <td style=\"text-align:right;\"> 0.079 </td>\n   <td style=\"text-align:right;\"> 0.452 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> hr </td>\n   <td style=\"text-align:left;\"> Hazard-rate </td>\n   <td style=\"text-align:left;\"> ~1 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.897 </td>\n   <td style=\"text-align:right;\"> 0.515 </td>\n   <td style=\"text-align:right;\"> 0.177 </td>\n   <td style=\"text-align:right;\"> 1.942 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n# What about the covariate?\n\nRecall, there are only 4 detections of females (10\\% of data set).  Possibly, that few detections might not have a strong influence on the parameter estimates of the detection function.  Nevertheless, apply the covariate to our models at our truncation distance:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhn.sex <- ds(mydata, key=\"hn\", truncation = truncate, convert_units = myunits,\n             formula=~sex)\nhr.sex <- ds(mydata, key=\"hr\", truncation = truncate, convert_units = myunits,\n             formula=~sex)\n# unicos.sex <- ds(mydata, key=\"unif\",  truncation = truncate, convert_units = myunits,\n# formula=~sex)\n```\n:::\n\n\n\nðŸ˜… uniform key function does not have a scale parameter $\\sigma$, hence cannot be fitted.  That reduces the number of models of interest to us.  We are left with the half normal and hazard rate keys, with and without the sex covariate and the uniform cosine that cannot support a covariate.  \n\nDo the models with covariates fit the data?  I expect they should because adding more parameters to a model ought to improve fit.  The half normal and hazard already fit the data without the covariate.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhn.sex.fit <- gof_ds(hn.sex, plot = FALSE, chisq = FALSE)$dsgof$CvM$p\nhr.sex.fit <- gof_ds(hr.sex, plot = FALSE, chisq = FALSE)$dsgof$CvM$p\ncovfits <- data.frame(modname=c(\"HN sex\", \"HR sex\"), \n                      CvMP=round(c(hn.sex.fit, hr.sex.fit),2))\nkable(covfits) %>%\n  kable_styling(full_width=FALSE, bootstrap_options=\"condensed\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> modname </th>\n   <th style=\"text-align:right;\"> CvMP </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> HN sex </td>\n   <td style=\"text-align:right;\"> 0.73 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> HR sex </td>\n   <td style=\"text-align:right;\"> 0.86 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## AIC among remaining five competitors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(unicos, hn, hr, hn.sex, hr.sex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       df      AIC\nunicos  1 307.7994\nhn      1 307.3470\nhr      2 309.2887\nhn.sex  2 304.1897\nhr.sex  3 305.6042\n```\n\n\n:::\n:::\n\n\n\nWhat emerges?  Half normal and uniform with cosine adjustment have very similar shapes and are quite similar models.  The hazard rate key without a covariate seems out of contention.  What about the similarity in $\\hat{P_a}$ between competing models?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(summarize_ds_models(unicos, hn,hr, hn.sex, hr.sex, output=\"plain\"), digits=3, row.names = FALSE,\n                    caption=\"Five competing models with truncation at 50m\")  %>%\n      kable_styling(full_width = F) %>%\n      column_spec(5, background=\"yellow\", width=\"8em\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Five competing models with truncation at 50m</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:left;\"> Key function </th>\n   <th style=\"text-align:left;\"> Formula </th>\n   <th style=\"text-align:right;\"> C-vM $p$-value </th>\n   <th style=\"text-align:right;\"> Average detectability </th>\n   <th style=\"text-align:right;\"> se(Average detectability) </th>\n   <th style=\"text-align:right;\"> Delta AIC </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> hn.sex </td>\n   <td style=\"text-align:left;\"> Half-normal </td>\n   <td style=\"text-align:left;\"> ~sex </td>\n   <td style=\"text-align:right;\"> 0.727 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.567 </td>\n   <td style=\"text-align:right;\"> 0.092 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> hr.sex </td>\n   <td style=\"text-align:left;\"> Hazard-rate </td>\n   <td style=\"text-align:left;\"> ~sex </td>\n   <td style=\"text-align:right;\"> 0.863 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.449 </td>\n   <td style=\"text-align:right;\"> 0.198 </td>\n   <td style=\"text-align:right;\"> 1.415 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> hn </td>\n   <td style=\"text-align:left;\"> Half-normal </td>\n   <td style=\"text-align:left;\"> ~1 </td>\n   <td style=\"text-align:right;\"> 0.683 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.638 </td>\n   <td style=\"text-align:right;\"> 0.091 </td>\n   <td style=\"text-align:right;\"> 3.157 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> unicos </td>\n   <td style=\"text-align:left;\"> Uniform with cosine adjustment term of order 1 </td>\n   <td style=\"text-align:left;\"> NA </td>\n   <td style=\"text-align:right;\"> 0.706 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.624 </td>\n   <td style=\"text-align:right;\"> 0.079 </td>\n   <td style=\"text-align:right;\"> 3.610 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> hr </td>\n   <td style=\"text-align:left;\"> Hazard-rate </td>\n   <td style=\"text-align:left;\"> ~1 </td>\n   <td style=\"text-align:right;\"> 0.897 </td>\n   <td style=\"text-align:right;width: 8em; background-color: yellow !important;\"> 0.515 </td>\n   <td style=\"text-align:right;\"> 0.177 </td>\n   <td style=\"text-align:right;\"> 5.099 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\nModels without sex as a covariate estimate a larger $\\hat{P_a}$, so even with only 4 female detections, those detections do exert an influence upon the shape of the estimated detection function and consequently upon $\\hat{P_a}$.\n\n# Are estimated $\\hat{P_a}(z_i)$ too small?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(p_dist_table(hn.sex, bins=seq(0,0.8,0.1), proportion=TRUE), digits=3,\n      caption=\"Estimated detection probabilities from HN with sex covariate.\") %>%\n  kable_styling(full_width=FALSE, bootstrap_options=\"condensed\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Estimated detection probabilities from HN with sex covariate.</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> p </th>\n   <th style=\"text-align:right;\"> count </th>\n   <th style=\"text-align:right;\"> proportion </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 0 - 0.1 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.1 - 0.2 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.2 - 0.3 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.3 - 0.4 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.4 - 0.5 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.5 - 0.6 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.6 - 0.7 </td>\n   <td style=\"text-align:right;\"> 36 </td>\n   <td style=\"text-align:right;\"> 0.9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 0.7 - 0.8 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.0 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThis distribution violates the guideline that <5\\% of $\\hat{P_a}$ should be less than 0.2.  But I'm willing to overlook that.  \n\n# Estimated detection function\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(hn.sex$ddf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nSummary for ds object\nNumber of observations :  40 \nDistance range         :  0  -  50 \nAIC                    :  304.1897 \nOptimisation           :  mrds (nlminb) \n\nDetection function:\n Half-normal key function \n\nDetection function parameters \nScale coefficient(s): \n            estimate        se\n(Intercept) 2.175139 0.3170033\nsexmale     1.242131 0.4112716\n\n                      Estimate          SE        CV\nAverage p            0.5671481  0.09190364 0.1620452\nN in covered region 70.5283160 13.91222961 0.1972574\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(hn.sex, main=\"Half normal with sex covariate\")\nadd_df_covar_line(hn.sex, mydata, lty=1, lwd=2, col=c(\"red\", \"blue\"))\nlegend(\"topright\", \n       c(\"Average\", \"Males\", \"Females\"),\n       col=c(\"black\", \"red\", \"blue\"),\n       lty=1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plotfn-1.png){width=672}\n:::\n:::\n\n\n\nNote the average (across sexes) detection probability curve is displaced toward the males that represent the largest proportion of the detections.\n\n# Estimated abundance\n\n## Best model, Half normal with sex covariate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(hn.sex$dht$individual$N)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Label Estimate       se        cv      lcl      ucl      df\n1 Total 164.5661 32.04176 0.1947045 111.3911 243.1253 38.7038\n```\n\n\n:::\n:::\n\n\n\nIf we wanted to employ the *gold standard* in precision estimation, we would apply a bootstrap\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbootout <- bootdht(hn.sex, flatfile=mydata, summary_fun = bootdht_Nhat_summarize,\n                   nboot=500, cores=10, convert_units = myunits)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPerforming 500 bootstraps\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nProgress bars cannot be shown when using cores>1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(bootout$Nhat, breaks = 20, \n     main=\"Distribution of bootstrap replicates\", xlab=\"Abundance estimate\")\nmybounds <- round(quantile(bootout$Nhat, c(0.025, 0.975),na.rm=TRUE))\nabline(v=mybounds, lwd=2, lty=3)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plotit-1.png){width=672}\n:::\n:::\n\n\n\nConfidence interval bounds from bootstrap are (124, 418), somewhat wider than the analytical confidence interval bounds specified above.\n\n## Closest AIC score competitor, Hazard rate with sex covariate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(hr.sex$dht$individual$N)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Label Estimate      se        cv     lcl      ucl       df\n1 Total 207.7639 95.9443 0.4617948 85.8307 502.9186 47.96291\n```\n\n\n:::\n:::\n\n\n\nNotice the price, in terms of precision, paid for the extra parameter estimated in the hazard rate model compared to the half normal model.\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Point and 95% interval estimates based upon truncation distance of 50m.](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}