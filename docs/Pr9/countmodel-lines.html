<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Centre for Research into Ecological and Environmental Modelling   University of St Andrews">
<meta name="dcterms.date" content="2024-03-22">

<title>Distance sampling workshop - Effect of habitat covariate upon estimated density—lines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "lk4dxekwqr");
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Distance sampling workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../Pr1/sampling.html"> 
<span class="menu-text">Sampling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr2/detnfns.html"> 
<span class="menu-text">Detection functions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr3/criticism.html"> 
<span class="menu-text">Criticism</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr4/precision.html"> 
<span class="menu-text">Precision</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr5/points.html"> 
<span class="menu-text">Points</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr6/design.html"> 
<span class="menu-text">Design</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr7/strata.html"> 
<span class="menu-text">Strata</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Pr8/covariates.html"> 
<span class="menu-text">Covariates</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../Pr9/multipliers.html" aria-current="page"> 
<span class="menu-text">Multipliers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../extras/extras.html"> 
<span class="menu-text">Extras</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Pr9/countmodel-lines.html">Effect of habitat covariate upon estimated density—lines</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Pr9/multipliers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multipliers practical 9</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Pr9/Pr9-instructions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analyses using multipliers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Pr9/multi-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multispecies and multisession distance sampling analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Pr9/countmodel-lines.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Effect of habitat covariate upon estimated density—lines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Pr9/Prac9_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis with multipliers <strong>solution</strong></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#ecological-question-and-data" id="toc-ecological-question-and-data" class="nav-link active" data-scroll-target="#ecological-question-and-data">Ecological question and data</a></li>
  <li><a href="#programming-matters" id="toc-programming-matters" class="nav-link" data-scroll-target="#programming-matters">Programming matters</a></li>
  <li><a href="#analysis-of-line-transect-survey" id="toc-analysis-of-line-transect-survey" class="nav-link" data-scroll-target="#analysis-of-line-transect-survey">Analysis of line transect survey</a>
  <ul class="collapse">
  <li><a href="#data-organisation" id="toc-data-organisation" class="nav-link" data-scroll-target="#data-organisation">Data organisation</a></li>
  <li><a href="#analysis-parameters-specification" id="toc-analysis-parameters-specification" class="nav-link" data-scroll-target="#analysis-parameters-specification">Analysis parameters specification</a></li>
  <li><a href="#fit-detection-function" id="toc-fit-detection-function" class="nav-link" data-scroll-target="#fit-detection-function">Fit detection function</a>
  <ul class="collapse">
  <li><a href="#plot-of-detection-function" id="toc-plot-of-detection-function" class="nav-link" data-scroll-target="#plot-of-detection-function">Plot of detection function</a></li>
  </ul></li>
  <li><a href="#prepare-for-glm-computation" id="toc-prepare-for-glm-computation" class="nav-link" data-scroll-target="#prepare-for-glm-computation">Prepare for GLM computation</a></li>
  <li><a href="#digression-for-computing-effective-area" id="toc-digression-for-computing-effective-area" class="nav-link" data-scroll-target="#digression-for-computing-effective-area">Digression for computing Effective Area</a></li>
  <li><a href="#estimate-relationship-of-density-and-covariate" id="toc-estimate-relationship-of-density-and-covariate" class="nav-link" data-scroll-target="#estimate-relationship-of-density-and-covariate">Estimate relationship of density and covariate</a></li>
  <li><a href="#visualise" id="toc-visualise" class="nav-link" data-scroll-target="#visualise">Visualise</a></li>
  <li><a href="#incorporate-uncertainty" id="toc-incorporate-uncertainty" class="nav-link" data-scroll-target="#incorporate-uncertainty">Incorporate uncertainty</a></li>
  <li><a href="#inference-regarding-the-habitat-covariate" id="toc-inference-regarding-the-habitat-covariate" class="nav-link" data-scroll-target="#inference-regarding-the-habitat-covariate">Inference regarding the habitat covariate</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Effect of habitat covariate upon estimated density—lines</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Centre for Research into Ecological and Environmental Modelling <br> <strong>University of St Andrews</strong> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 22, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Investigators often wish to make inferences from their surveys beyond simply reporting “What is the animal density?” Ecological curiosity desires answers to questions such as</p>
<blockquote class="blockquote">
<p>What effect does change in habitat characteristic X have upon animal density?</p>
</blockquote>
<p>Answers to such questions are sought through use of generalised linear modelling (of which analysis of variance and regression are subsets). However, simple modelling of counts fails to take into account imperfect detectability. When detectability is imperfect, the response variable possesses uncertainty derived from uncertainty in the probability of detection.</p>
<p>A number of authors have recognised the need to incorporate this uncertainty into the analysis of habitat effects upon estimated density. One approach (employed here) conducts the analyses in two stages: first detectability is estimated and <span class="math inline">\(P_a\)</span> or <span class="math inline">\(\mu\)</span> or <span class="math inline">\(\rho\)</span> is estimated. A second stage fits a model to count data adjusting using the estimated detectability parameters. This approach is exemplified by <span class="citation" data-cites="Buckland2009a">Buckland et al. (<a href="#ref-Buckland2009a" role="doc-biblioref">2009</a>)</span>. Alternatively, single state approaches have been described by <span class="citation" data-cites="rodriguezTortoiseAbundances2017">Rodríguez-Caro et al. (<a href="#ref-rodriguezTortoiseAbundances2017" role="doc-biblioref">2017</a>)</span>.</p>
<p>Propagation of uncertainty from the first step into the second step is accomplished via a bootstrap, with the effective area sampled serving as an offset in the generalised linear modelling (GLM) analysis. The method described herein only applies when the link function is the <code>log</code> link, for the following reason.</p>
<p>We want to model bird density in our GLM, derived from the counts we observed on each transect. Density is defined as</p>
<p><span class="math display">\[D = \frac{n}{\text{Eff Area}} \]</span> where <span class="math inline">\(n\)</span> is the count on each transect.</p>
<p>Therefore</p>
<p><span class="math display">\[\frac{n}{\text{Eff Area}} = e^{\text{linear predictor}}\]</span> when using a <code>log</code> link function.</p>
<p>Our count model works with <code>n</code> as the response variable <span class="math display">\[
\begin{align}
n &amp;= \text{Eff Area} \cdot e^{\text{linear predictor}} \\
&amp;= e^{\text{linear predictor} + log(\text{Eff Area})}
\end{align}
\]</span></p>
<p>making <span class="math inline">\(log(\text{Eff Area})\)</span> the offset. If other link functions are used, the offset will be different.</p>
<section id="ecological-question-and-data" class="level1">
<h1>Ecological question and data</h1>
<p>We present an example of such an analysis, using data from the package <code>RDistance</code> <span class="citation" data-cites="McDonald2019">(<a href="#ref-McDonald2019" role="doc-biblioref">McDonald et al., 2019</a>)</span>. We fit detection detection functions to data using the <code>Distance</code> package <span class="citation" data-cites="Miller2019">Miller et al. (<a href="#ref-Miller2019" role="doc-biblioref">2019</a>)</span>. We analyse a line transect survey consisting of 72 transects with interest in effect of habitat features upon density of Brewer’s sparrows <em>(Spizella breweri)</em> <span class="citation" data-cites="carlisle_abundance_2020">(<a href="#ref-carlisle_abundance_2020" role="doc-biblioref">Carlisle &amp; Chalfoun, 2020</a>)</span>. The data organisation is one data frame containing information on detections and another data frame containing information for each transect.</p>
</section>
<section id="programming-matters" class="level1">
<h1>Programming matters</h1>
<p>Before walking through the code, we provide some guidance regarding adaptation of this approach for your data. The code is not sufficiently modularised so that you can merely slot your data into a function. There are matters to consider regarding data organisation, naming of data frame columns, choice of detection functions to fit and specification of count model used for inference. These points are summarised in the box below.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Programming details to adapt for your use</strong></p>
<ul>
<li>Check the data organisation
<ul>
<li>follows the layout of <code>RDistance</code>:
<ul>
<li>data frame with detections</li>
<li>data frame with transect-level covariates</li>
<li>data frames eventually are merged, but create them separately</li>
</ul></li>
<li>check the field names of the data frames for compatibility with the <code>Distance</code> package</li>
</ul></li>
<li>Recognise your survey design should have a large number of replicate transects</li>
<li>Detection function modelling described herein uses covariates specific to this data set</li>
<li>The GLM model is specified just once and the formula object is reused as needed
<ul>
<li>Exercise of this code has only been applied to continuous univariate predictors</li>
<li>More complex models could be fitted, but the graphical output may be compromised</li>
<li>Figure-generating code adapts to the GLM model formula
<ul>
<li>however graphic code breaks of explanatory covariate is a factor covariate</li>
</ul></li>
</ul></li>
<li>There is no error trapping code, specifically in the bootstrapping routine</li>
</ul>
</div>
</div>
</section>
<section id="analysis-of-line-transect-survey" class="level1">
<h1>Analysis of line transect survey</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rdistance)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sparrowDetectionData"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sparrowSiteData"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>sparrowSiteData<span class="sc">$</span>myCount <span class="ot">&lt;-</span> <span class="fu">tapply</span>(sparrowDetectionData<span class="sc">$</span>groupsize,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                                  sparrowDetectionData<span class="sc">$</span>siteID, length)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>sparrowSiteData<span class="sc">$</span>myCount[<span class="fu">is.na</span>(sparrowSiteData<span class="sc">$</span>myCount)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Distance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-organisation" class="level2">
<h2 class="anchored" data-anchor-id="data-organisation">Data organisation</h2>
<p>In Carlisle’s data set, sightings information is kept separate from information about each site. For our purposes, we will merge those together. In addition, some field names are changed for consistency with functions in the <code>Distance</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>newsparrow <span class="ot">&lt;-</span> <span class="fu">merge</span>(sparrowDetectionData, sparrowSiteData, <span class="at">by=</span><span class="st">"siteID"</span>, <span class="at">all=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newsparrow) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"observer"</span>, <span class="st">"obs"</span>, <span class="fu">names</span>(newsparrow))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newsparrow) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"dist"</span>, <span class="st">"distance"</span>, <span class="fu">names</span>(newsparrow))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newsparrow) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"length"</span>, <span class="st">"Effort"</span>, <span class="fu">names</span>(newsparrow))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>newsparrow<span class="sc">$</span>distance <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(newsparrow<span class="sc">$</span>distance)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>newsparrow<span class="sc">$</span>Effort <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(newsparrow<span class="sc">$</span>Effort)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis-parameters-specification" class="level2">
<h2 class="anchored" data-anchor-id="analysis-parameters-specification">Analysis parameters specification</h2>
<p>Although not formally written as a set of functions, we bring to the front of the code arguments the user will need to change to alter to suite their needs. Candidate transect-level predictors for the detection function are <strong>observer, bare, herb, shrub, height, shrubclass</strong>. The same predictors, with the exception of <strong>observer</strong> could be used to model the sparrow counts.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span>          <span class="co"># type I error rate for confidence intervals</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pointtransect <span class="ot">&lt;-</span> <span class="cn">FALSE</span>        <span class="co"># survey conducted using lines or points</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dettrunc <span class="ot">&lt;-</span> <span class="dv">100</span>  <span class="co"># truncation for detection function</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>transect.length <span class="ot">&lt;-</span> newsparrow<span class="sc">$</span>Effort[<span class="dv">1</span>] <span class="co"># each transect the same length</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>meterstohectares <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>myglmmodel <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(myCount <span class="sc">~</span> shrub <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(effArea)))  <span class="co"># habitat model to fit to animal density</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>nboot <span class="ot">&lt;-</span> <span class="dv">50</span>       <span class="co"># number of bootstrap replicates</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">255992</span>)   <span class="co"># random number seed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="fit-detection-function" class="level2">
<h2 class="anchored" data-anchor-id="fit-detection-function">Fit detection function</h2>
<p>We fit a series of detection function models using the transect-level covariates available in the Brewer’s sparrow data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>surveytype <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pointtransect, <span class="st">"point"</span>, <span class="st">"line"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>woo.o <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span>obs, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>woo.bare <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span>bare,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>woo.ht <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span>height, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>woo.shrc <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span>shrubclass, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>woo.shrub <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span>shrub, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>woo <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newsparrow, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span><span class="sc">~</span><span class="dv">1</span>, </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">transect=</span>surveytype, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">summarize_ds_models</span>(woo.o,  woo.bare,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                 woo.ht, woo.shrc, woo.shrub, woo), <span class="at">digits=</span><span class="dv">3</span>, </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption=</span><span class="st">"Halfnormal detection function model selection of covariates."</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Halfnormal detection function model selection of covariates.</caption>
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: left;">Key function</th>
<th style="text-align: left;">Formula</th>
<th style="text-align: right;">C-vM p-value</th>
<th style="text-align: right;"><span class="math inline">\(\hat{P_a}\)</span></th>
<th style="text-align: right;">se(<span class="math inline">\(\hat{P_a}\)</span>)</th>
<th style="text-align: right;"><span class="math inline">\(\Delta\)</span>AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~bare</td>
<td style="text-align: right;">0.526</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~shrubclass</td>
<td style="text-align: right;">0.511</td>
<td style="text-align: right;">0.559</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">1.689</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~height</td>
<td style="text-align: right;">0.492</td>
<td style="text-align: right;">0.558</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">2.014</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~shrub</td>
<td style="text-align: right;">0.476</td>
<td style="text-align: right;">0.559</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">2.691</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right;">0.469</td>
<td style="text-align: right;">0.563</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">4.843</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~obs</td>
<td style="text-align: right;">0.587</td>
<td style="text-align: right;">0.559</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">8.837</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>winner <span class="ot">&lt;-</span> woo.bare</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All of the candidate models fit the Brewer’s sparrow line transect data. Also note that the estimate detection probability of all six models is the same to the third decimal. The detection function model using bare ground as a predictor is slightly favoured by AIC; we will base our inference on the detection function that includes <code>bare</code> as a covariate. There is likely little effect of this model selection choice upon the ecological question of interest.</p>
<section id="plot-of-detection-function" class="level3">
<h3 class="anchored" data-anchor-id="plot-of-detection-function">Plot of detection function</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula <span class="sc">==</span> <span class="st">"~obs"</span>) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(woo.o, <span class="at">showpoints=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Brewer's sparrow</span><span class="sc">\n</span><span class="st">Detection with observer covariate"</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.o, <span class="fu">data.frame</span>(<span class="at">obs=</span><span class="st">"obs1"</span>), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.o, <span class="fu">data.frame</span>(<span class="at">obs=</span><span class="st">"obs2"</span>), <span class="at">col=</span><span class="st">"green"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.o, <span class="fu">data.frame</span>(<span class="at">obs=</span><span class="st">"obs3"</span>), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.o, <span class="fu">data.frame</span>(<span class="at">obs=</span><span class="st">"obs4"</span>), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.o, <span class="fu">data.frame</span>(<span class="at">obs=</span><span class="st">"obs5"</span>), <span class="at">col=</span><span class="st">"purple"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title=</span><span class="st">"Observer"</span>, <span class="at">legend=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>, <span class="st">"darkgreen"</span>, <span class="st">"blue"</span>, <span class="st">"purple"</span>))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula <span class="sc">==</span> <span class="st">"~bare"</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(woo.bare, <span class="at">showpoints=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Brewer's sparrow</span><span class="sc">\n</span><span class="st">Detection with bare ground covariate"</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  quantvals <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sparrowSiteData<span class="sc">$</span>bare, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.bare, <span class="fu">data.frame</span>(<span class="at">bare=</span>quantvals[<span class="dv">1</span>]), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.bare, <span class="fu">data.frame</span>(<span class="at">bare=</span>quantvals[<span class="dv">2</span>]), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.bare, <span class="fu">data.frame</span>(<span class="at">bare=</span>quantvals[<span class="dv">3</span>]), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title=</span><span class="st">"Bare ground"</span>, <span class="at">legend=</span>quantvals,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span>))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula <span class="sc">==</span> <span class="st">"~height"</span>) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(woo.ht, <span class="at">showpoints=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Brewer's sparrow</span><span class="sc">\n</span><span class="st">Detection with shrub height covariate"</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  threeheights <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sparrowSiteData<span class="sc">$</span>height, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.ht, <span class="fu">data.frame</span>(<span class="at">height=</span>threeheights[<span class="dv">1</span>]), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.ht, <span class="fu">data.frame</span>(<span class="at">height=</span>threeheights[<span class="dv">2</span>]), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.ht, <span class="fu">data.frame</span>(<span class="at">height=</span>threeheights[<span class="dv">3</span>]), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title=</span><span class="st">"Shrub height"</span>, <span class="at">legend=</span>threeheights,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span>))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula <span class="sc">==</span> <span class="st">"~shrubclass"</span>) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(woo.shrc, <span class="at">showpoints=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Brewer's sparrow</span><span class="sc">\n</span><span class="st">Detection with shrub height class covariate"</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.shrc, <span class="fu">data.frame</span>(<span class="at">shrubclass=</span><span class="st">"Low"</span>), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.shrc, <span class="fu">data.frame</span>(<span class="at">shrubclass=</span><span class="st">"High"</span>), <span class="at">col=</span><span class="st">"green"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title=</span><span class="st">"Shrub height class"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>),</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula <span class="sc">==</span> <span class="st">"~shrub"</span>) {</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(woo.shrc, <span class="at">showpoints=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Brewer's sparrow</span><span class="sc">\n</span><span class="st">Detection with percent shrub covariate"</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  quantvals <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sparrowSiteData<span class="sc">$</span>shrub, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>))</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.shrub, <span class="fu">data.frame</span>(<span class="at">shrub=</span>quantvals[<span class="dv">1</span>]), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.shrub, <span class="fu">data.frame</span>(<span class="at">shrub=</span>quantvals[<span class="dv">2</span>]), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_df_covar_line</span>(woo.shrub, <span class="fu">data.frame</span>(<span class="at">shrub=</span>quantvals[<span class="dv">3</span>]), <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">pdf=</span>pointtransect) </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">title=</span><span class="st">"Shrub cover"</span>, <span class="at">legend=</span>quantvals,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>))</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="countmodel-lines_files/figure-html/detfnplot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="prepare-for-glm-computation" class="level2">
<h2 class="anchored" data-anchor-id="prepare-for-glm-computation">Prepare for GLM computation</h2>
<p>Considerable processing is necessary to correctly calculate the offset value for the GLM. The offset is the effective area sampled by each transect. Effective area <span class="math inline">\((EA)\)</span> is computed differently, depending upon whether sampling was done with line or point transects.</p>
<ul>
<li>For line transects the computation uses the effective strip half-width <span class="math inline">\((ESW)\)</span> multiplied by 2 (for each side of the transect), multiplied by the transect length. <span class="math inline">\(ESW\)</span> is derived for each detection by acquiring the detection probability for the detection from the fitted detection function object <code>detfnobj$ddf$fitted</code>. However a detection probability is only computed for detections at distances less than the truncation distance; so some coding is required to deal with detections beyond the truncation distance. <span class="math inline">\(ESW\)</span> is derived from <span class="math inline">\(P_a\)</span> as <span class="math inline">\(P_a \cdot w\)</span> where <span class="math inline">\(w\)</span> is the truncation distance.</li>
<li>For point transects, effective area is computed as <span class="math inline">\(\pi \cdot P_a \cdot w^2\)</span>. This value is returned directly when the <code>predict()</code> function is used, but is derived by calculation from the fitted detection function object <code>detfnobj$ddf$fitted</code> for each detection.</li>
</ul>
<p>There is also a distinction between line and point transect computations regarding units in which data are recorded. For line transect example of Brewers Sparrows, <code>Effort</code> was measured in meters, but we wish to produce our estimates of density in numbers per hectare. With Thresher Sparrows, radial detection distance was measured in meters, but we wish to measure bird density in numbers per hectare. In both cases, division by 10000 to convert square meters to hectares.</p>
<p>Because only need transect level information, the observation-level information can be removed, to make computation easier. However, transects on which animals were not detected (counts=0) must also be carried forward to the GLM analysis; because 0’s constitute legitimate observations. If the offset values remained missing values (NA), the relationship between animal density and the predictor covariate(s) would not be properly estimated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sparrowSiteData<span class="sc">$</span>effArea <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">predict</span>(winner,<span class="at">newdata=</span><span class="fu">data.frame</span>(<span class="at">obs=</span>sparrowSiteData<span class="sc">$</span>obs, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                                                               <span class="at">bare=</span>sparrowSiteData<span class="sc">$</span>bare,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                                               <span class="at">herb=</span>sparrowSiteData<span class="sc">$</span>herb, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                                               <span class="at">shrub=</span>sparrowSiteData<span class="sc">$</span>shrub,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                                               <span class="at">height=</span>sparrowSiteData<span class="sc">$</span>height, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                                               <span class="at">shrubclass=</span>sparrowSiteData<span class="sc">$</span>shrubclass),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">esw=</span><span class="cn">TRUE</span>)<span class="sc">$</span>fitted<span class="sc">*</span>transect.length<span class="sc">/</span>meterstohectares</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>sitesadj <span class="ot">&lt;-</span> sparrowSiteData</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="digression-for-computing-effective-area" class="level2">
<h2 class="anchored" data-anchor-id="digression-for-computing-effective-area">Digression for computing Effective Area</h2>
<p>I could not convince <code>predict.ds()</code> to behave, so I reverted to first principles. In the function below, I “manually” compute the detection function in the presence of a covariate, demonstrated in the code as <code>shrub</code> as if <code>shrub</code> was the covariate in the detection function. Effective strip width is computed for each transect (below) by integrating this function at the specified level of the covariate for each transect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gz<span class="ot">&lt;-</span><span class="cf">function</span>(z,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>             beta, sigintercept, sigcoef, DistWin,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">key=</span><span class="st">"HR"</span>, <span class="at">w=</span><span class="fu">max</span>(z), predictor){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#this is a generic detection function that returns the probability of detecting an animal</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    z               generic distance (perpendicular) - can be scalar or vector</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    beta            shape coefficient</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    sigintercept  intercept coefficient for sigma</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">#    sigcoef         coefficient for specific factor level</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#    key             the detection function key, works for hazard rate and half normal</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#    w               truncation distance, by default the max of the distances</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#    predictor     the covariate within the detection function influencing sigma</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">#RETURNS: a probability</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(key <span class="sc">!=</span> <span class="st">"HN"</span> <span class="sc">&amp;</span> key <span class="sc">!=</span> <span class="st">"HR"</span>) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Argument 'key' must be either HN or HR"</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">exp</span>(sigintercept <span class="sc">+</span> sigcoef<span class="sc">*</span>predictor)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  exponent <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(key<span class="sc">==</span><span class="st">"HR"</span>) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    scale.dist <span class="ot">&lt;-</span> z<span class="sc">/</span>sigma</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    inside <span class="ot">&lt;-</span> <span class="sc">-</span>(scale.dist)<span class="sc">^</span>(<span class="sc">-</span>exponent)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    gx <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(inside)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    scale.dist <span class="ot">&lt;-</span> z  <span class="co"># debatably don't scale for half normal</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    inside <span class="ot">&lt;-</span> <span class="sc">-</span>(scale.dist<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>sigma<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    gx <span class="ot">&lt;-</span> <span class="fu">exp</span>(inside)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(gx)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="estimate-relationship-of-density-and-covariate" class="level2">
<h2 class="anchored" data-anchor-id="estimate-relationship-of-density-and-covariate">Estimate relationship of density and covariate</h2>
<p>Fit a GLM to the observed counts, using as an offset the estimated effective area. By default, specifying family as <code>poisson</code> assumes a <code>log</code> link function. Consequently, the offset must also use the <code>log</code> transform.</p>
<p>To generalise the code, and recognising the same call to <code>glm()</code> will need to be made elsewhere in this analysis, we specify the GLM model we wish to fit as an object of type <code>formula</code>. This was specified in the <a href="#analysis-parameters-specification">Analysis parameters specification</a> section above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>univarpredictor <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(myglmmodel)[<span class="dv">2</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>glmmodel <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula=</span>myglmmodel, <span class="at">family=</span><span class="st">"poisson"</span>, <span class="at">data=</span>sitesadj)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>modelsum <span class="ot">&lt;-</span> <span class="fu">summary</span>(glmmodel)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>tablecaption <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"GLM coefficients from counts as function of"</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                      univarpredictor, <span class="st">"with log(effective area) offset."</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(modelsum<span class="sc">$</span>coef, <span class="at">digits=</span><span class="dv">4</span>, <span class="at">caption=</span>tablecaption)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-basicglmline" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-basicglmline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: GLM coefficients from counts as function of shrub with log(effective area) offset.
</figcaption>
<div aria-describedby="tbl-basicglmline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Std. Error</th>
<th style="text-align: right;">z value</th>
<th style="text-align: right;">Pr(&gt;|z|)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.2375</td>
<td style="text-align: right;">0.1431</td>
<td style="text-align: right;">-8.6477</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">shrub</td>
<td style="text-align: right;">0.0886</td>
<td style="text-align: right;">0.0101</td>
<td style="text-align: right;">8.8100</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="visualise" class="level2">
<h2 class="anchored" data-anchor-id="visualise">Visualise</h2>
<p>Even though we have computed the effective area for each transect based upon the fitted detection function, we have not used that effective area to adjust the observed counts. The simple formula</p>
<p><span class="math display">\[\hat{D}_i = \frac{n_i}{EA_i}, i = 1, \ldots , n_{transects}\]</span> where <span class="math inline">\(EA_i\)</span> is the effective area for the <span class="math inline">\(i^{th}\)</span> transect, describes this adjustment.</p>
<p>We plot the estimated density against the continuous univariate predictor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sitesadj<span class="sc">$</span>density <span class="ot">&lt;-</span> sitesadj<span class="sc">$</span>myCount <span class="sc">/</span> sitesadj<span class="sc">$</span>effArea </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="incorporate-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="incorporate-uncertainty">Incorporate uncertainty</h2>
<p>We resample our transects with replacement to assess the uncertainty in our point estimates of the relationship between the habitat covariate and the response variable. Specify the number of bootstrap resamples required and allocate storage for the replicate estimates of the GLM parameters: intercept and slope.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>intercept.est <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"numeric"</span>, <span class="at">length=</span>nboot)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>slope.est <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"numeric"</span>, <span class="at">length=</span>nboot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specify the original site data frame <code>sparrowSiteData</code> in the following code. The code will harvest the estimated slope and intercept coefficients from each replicate. It is uncertainty in the slope coefficient (<span class="math inline">\(\widehat{\beta_1}\)</span>) that determines our inference about the effect of shrub cover upon Brewer’s sparrow density. The uncertainty in the slope coefficient as calculated by the code below differs from the uncertainty reported in <a href="#tbl-basicglmline" class="quarto-xref">Table&nbsp;1</a> because below we are incorporating uncertainty in the relationship induced by uncertainty in the detection function, which is not recognised in <a href="#tbl-basicglmline" class="quarto-xref">Table&nbsp;1</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>num.transects <span class="ot">&lt;-</span> <span class="fu">dim</span>(sparrowSiteData)[<span class="dv">1</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (theboot <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nboot) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  newdetects <span class="ot">&lt;-</span> <span class="fu">data.frame</span>() </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  bob <span class="ot">&lt;-</span> <span class="fu">sample</span>(sparrowSiteData<span class="sc">$</span>siteID, <span class="at">replace=</span><span class="cn">TRUE</span>, <span class="at">size=</span><span class="fu">length</span>(<span class="fu">unique</span>(sparrowSiteData<span class="sc">$</span>siteID)))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  print(unique(bob))</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (bootsite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bob)) { </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    thissite <span class="ot">&lt;-</span> bob[bootsite] </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    glob <span class="ot">&lt;-</span> newsparrow[newsparrow<span class="sc">$</span>siteID<span class="sc">==</span>thissite, ]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    glob<span class="sc">$</span>siteID <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"rep%02d"</span>, bootsite)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    newdetects <span class="ot">&lt;-</span> <span class="fu">rbind</span>(newdetects, glob)  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  newdetects <span class="ot">&lt;-</span> newdetects[<span class="fu">order</span>(newdetects<span class="sc">$</span>siteID), ]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Refit the detection function model, using observer as a covariate, to the bootstrap replicate</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  detectcovar <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  detfnmod <span class="ot">&lt;-</span> <span class="fu">ds</span>(<span class="at">data=</span>newdetects, <span class="at">truncation=</span>dettrunc, <span class="at">formula=</span>detectcovar, <span class="at">quiet=</span><span class="cn">TRUE</span>, <span class="at">optimizer =</span> <span class="st">"R"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  Compute effective area offset for each transect</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  09Mar24 simplify to just transect-level data</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  newtransects <span class="ot">&lt;-</span> newdetects[<span class="sc">!</span><span class="fu">duplicated</span>(newdetects<span class="sc">$</span>siteID), ]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  esw <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">"numeric"</span>, <span class="at">length=</span>num.transects)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  hold <span class="ot">&lt;-</span> detfnmod<span class="sc">$</span>ddf<span class="sc">$</span>par</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (transect <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num.transects) { </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    esw[transect] <span class="ot">&lt;-</span> <span class="fu">integrate</span>(gz, <span class="at">lower=</span><span class="dv">0</span>, <span class="at">upper=</span>dettrunc, <span class="at">key=</span><span class="st">"HN"</span>, </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                               <span class="at">beta=</span><span class="dv">0</span>, <span class="at">sigintercept =</span> hold[<span class="dv">1</span>], </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sigcoef =</span> hold[<span class="dv">2</span>], <span class="at">DistWin=</span><span class="cn">FALSE</span>, </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                               <span class="at">predictor=</span>newtransects[transect, <span class="fu">substr</span>(winner<span class="sc">$</span>ddf<span class="sc">$</span>ds<span class="sc">$</span>aux<span class="sc">$</span>ddfobj<span class="sc">$</span>scale<span class="sc">$</span>formula, <span class="dv">2</span>,<span class="dv">10</span>)])<span class="sc">$</span>value</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   If point transects, use effArea =  2 * esw * pi * truncation^2  </span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  newtransects<span class="sc">$</span>effArea <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> esw <span class="sc">*</span> transect.length<span class="sc">/</span>meterstohectares</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   refit the GLM for this bootstrap replicate</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  glmresult <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="at">formula=</span> myglmmodel, <span class="at">family=</span><span class="st">"poisson"</span>, <span class="at">data=</span>newtransects)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  intercept.est[theboot] <span class="ot">&lt;-</span> <span class="fu">coef</span>(glmresult)[<span class="dv">1</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  slope.est[theboot] <span class="ot">&lt;-</span> <span class="fu">coef</span>(glmresult)[<span class="dv">2</span>] </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Code below creates a comprehensive figure of the findings. Steps include</p>
<ul>
<li>generates the predicted relationship of the habitat and Brewer’s sparrow density for each bootstrap replicate,</li>
<li>computes point-wise confidence intervals,</li>
<li>plot the estimated relationship, all bootstrap replicate relationships and the confidence intervals,</li>
<li>insets sampling distribution of (<span class="math inline">\(\widehat{\beta_1}\)</span>) and places a confidence interval on the point estimate of (<span class="math inline">\(\widehat{\beta_1}\)</span>).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>predData <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">predictor=</span><span class="fu">seq</span>(<span class="fu">min</span>(sparrowSiteData[ , univarpredictor]),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">max</span>(sparrowSiteData[, univarpredictor]), <span class="at">length.out=</span><span class="dv">100</span>)) </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>orig.fit <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x=</span>predData<span class="sc">$</span>predictor, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y=</span><span class="fu">exp</span>(<span class="fu">coef</span>(glmmodel)[<span class="dv">1</span>] <span class="sc">+</span> (<span class="fu">coef</span>(glmmodel)[<span class="dv">2</span>]<span class="sc">*</span>predData<span class="sc">$</span>predictor)))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># long form data frame of all replicate predicted values</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>longform <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nboot) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  mypredict <span class="ot">&lt;-</span> <span class="fu">exp</span>(intercept.est[i] <span class="sc">+</span> (slope.est[i]<span class="sc">*</span>predData<span class="sc">$</span>predictor))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  longform <span class="ot">&lt;-</span> <span class="fu">c</span>(longform, mypredict)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>big.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">predict=</span>longform)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>big.df<span class="sc">$</span>shrub <span class="ot">&lt;-</span> predData<span class="sc">$</span>predictor</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>big.df<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>nboot, <span class="at">each=</span><span class="fu">length</span>(predData<span class="sc">$</span>predictor))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># point-wise confidence intervals</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>quants <span class="ot">&lt;-</span> big.df <span class="sc">%&gt;%</span> </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(shrub) <span class="sc">%&gt;%</span> </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower =</span> <span class="fu">quantile</span>(predict, alpha<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper =</span> <span class="fu">quantile</span>(predict, <span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">gather</span>(stat, value, <span class="sc">-</span>shrub)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co"># main plot</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>b0label <span class="ot">&lt;-</span> <span class="fu">bquote</span>(<span class="sc">~</span><span class="fu">widehat</span>(beta[<span class="dv">0</span>]) <span class="sc">==</span> .(<span class="fu">round</span>(<span class="fu">coef</span>(glmmodel)[<span class="dv">1</span>],<span class="dv">4</span>)))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>b1label <span class="ot">&lt;-</span> <span class="fu">bquote</span>(<span class="sc">~</span><span class="fu">widehat</span>(beta[<span class="dv">1</span>]) <span class="sc">==</span> .(<span class="fu">round</span>(<span class="fu">coef</span>(glmmodel)[<span class="dv">2</span>],<span class="dv">4</span>)))</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">dat=</span>sitesadj, <span class="fu">aes</span>(shrub, density)) <span class="sc">+</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>predict, <span class="at">group=</span>group), big.df, <span class="at">alpha=</span><span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>y, <span class="at">x=</span>x), orig.fit, <span class="at">colour=</span><span class="st">"red"</span>, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>value, <span class="at">group=</span>stat), quants, <span class="at">col=</span><span class="st">'blue'</span>, <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"text"</span>, <span class="at">x=</span><span class="dv">20</span>, <span class="at">y=</span><span class="fl">0.6</span>, <span class="at">label=</span> b0label, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"text"</span>, <span class="at">x=</span><span class="dv">20</span>, <span class="at">y=</span><span class="fl">0.3</span>, <span class="at">label=</span> b1label, <span class="at">size=</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Percent shrub cover"</span>, <span class="at">y=</span><span class="st">"Estimate bird density (per ha)"</span>,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">title=</span><span class="st">"Brewer's sparrow density as function of shrub cover"</span>,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle=</span><span class="fu">paste0</span>(<span class="st">"Detection function model includes "</span>, <span class="fu">as.character</span>(detectcovar)[<span class="dv">2</span>])) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># inset histogram for sampling distribution</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">quantile</span>(slope.est, <span class="at">probs =</span> <span class="fu">c</span>(alpha<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>fig2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x=</span>slope.est) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span>bounds, <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Estimate of slope"</span>, <span class="at">y=</span><span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"text"</span>, <span class="at">x=</span>bounds[<span class="dv">1</span>]<span class="sc">-</span>.<span class="dv">01</span>, <span class="at">y=</span><span class="dv">11</span>, <span class="at">label=</span><span class="fu">round</span>(bounds[<span class="dv">1</span>],<span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom=</span><span class="st">"text"</span>, <span class="at">x=</span>bounds[<span class="dv">2</span>]<span class="sc">+</span>.<span class="dv">01</span>, <span class="at">y=</span><span class="dv">11</span>, <span class="at">label=</span><span class="fu">round</span>(bounds[<span class="dv">2</span>],<span class="dv">3</span>)) </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>complete <span class="ot">&lt;-</span> fig1 <span class="sc">+</span> <span class="fu">inset_element</span>(fig2, <span class="at">right=</span>.<span class="dv">5</span>, <span class="at">bottom=</span>.<span class="dv">4</span>, <span class="at">left=</span>.<span class="dv">01</span>, <span class="at">top=</span>.<span class="dv">99</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>complete</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="countmodel-lines_files/figure-html/grandplot-1.png" class="img-fluid figure-img" width="1056"></p>
<figcaption>Relationship between univariate predictor and Brewer’s sparrow density as modelled by GLM. Offset is estimated covered area. Confidence intervals incorporate uncertainty from imperfect detectability. Inset is sampling distribution of the parameter of interest for Brewer’s sparrow.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="inference-regarding-the-habitat-covariate" class="level2">
<h2 class="anchored" data-anchor-id="inference-regarding-the-habitat-covariate">Inference regarding the habitat covariate</h2>
<p>To assess the effect of the transect-level environmental covariate upon bird density, we focus our attention on <span class="math inline">\(\hat{\beta_1}\)</span>. The greater in magnitude the slope of the covariate, the greater the effect of the covariate upon animal density. If the estimated slope (<span class="math inline">\(\hat{\beta_1}\)</span>) is indistinguishable from zero, we infer the habitat covariate has no influence upon animal density. For the habitat characteristic <code>shrub</code>, there is a positive response of Brewer’s sparrow to increasing shrub cover.</p>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>Inference regarding the relationship between animal density and habitat covariates is invariably made more difficult when detectability of animals is imperfect. Adjusting number of animals detected for this estimated probability of detection introduces uncertainty into investigation of the relationship. If this added uncertainty is disregarded, faulty inference (believing a relationship exists where there is none) can result.</p>
<p>In reality, it is more challenging to propagate the uncertainty via the bootstrap, than to calculate the point estimate of the relationship. Nevertheless, sound inference is achieved by adequately incorporating uncertainty in all accountable forms in our analysis.</p>
<p>This document contains code to perform this <em>count model analysis</em> for either line or point transects. What remains is to generalise this framework further, e.g.&nbsp;multiple predictor variables or more complex survey designs.</p>
</section>
<section id="acknowledgements" class="level1">
<h1>Acknowledgements</h1>
<p>The heart of the analysis presented was based upon code and ideas presented by Jason Carlisle and Trent McDonald in their <a href="https://github.com/tmcd82070/Rdistance/wiki/Modeling-abundance-in-relation-to-covariates"><code>RDistance wiki</code></a>.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Buckland2009a" class="csl-entry" role="listitem">
Buckland, S. T., Russell, R. E., Dickson, B. G., Saab, V. A., Gorman, D. N., &amp; Block, W. M. (2009). Analysing designed experiments in distance sampling. <em>Journal of Agricultural, Biological, and Environmental Statistics</em>, <em>14</em>, 432–442. <a href="https://doi.org/10.1198/jabes.2009.08030">https://doi.org/10.1198/jabes.2009.08030</a>
</div>
<div id="ref-carlisle_abundance_2020" class="csl-entry" role="listitem">
Carlisle, J., &amp; Chalfoun, A. (2020). The abundance of <span>Greater Sage</span>-<span>Grouse</span> as a proxy for the abundance of sagebrush-associated songbirds in <span>Wyoming</span>, <span>USA</span>. <em>Avian Conservation and Ecology</em>, <em>15</em>(2). <a href="https://doi.org/10.5751/ACE-01702-150216">https://doi.org/10.5751/ACE-01702-150216</a>
</div>
<div id="ref-McDonald2019" class="csl-entry" role="listitem">
McDonald, T., Carlisle, J., &amp; McDonald, A. (2019). <em>Rdistance: Distance sampling analysis for density and abundance estimation</em>.
</div>
<div id="ref-Miller2019" class="csl-entry" role="listitem">
Miller, D. L., Rexstad, E., Thomas, L., Marshall, L., &amp; Laake, J. L. (2019). Distance sampling in <span>R</span>. <em>Journal of Statistical Software</em>, <em>89</em>(1), 1–28. <a href="https://doi.org/10.18637/jss.v089.i01">https://doi.org/10.18637/jss.v089.i01</a>
</div>
<div id="ref-rodriguezTortoiseAbundances2017" class="csl-entry" role="listitem">
Rodríguez-Caro, R. C., Oedekoven, C. S., Graciá, E., Anadón, J. D., Buckland, S. T., Esteve-Selma, M. A., … Giménez, A. (2017). Low tortoise abundances in pine forest plantations in forest-shrubland transition areas. <em>PLOS ONE</em>, <em>12</em>(3), e0173485. <a href="https://doi.org/10.1371/journal.pone.0173485">https://doi.org/10.1371/journal.pone.0173485</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>