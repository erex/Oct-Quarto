<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eric Rexstad">
<meta name="dcterms.date" content="2024-03-15">
<meta name="description" content="Remember, the most important aspect of this exercise is the workflow that you followed, the decisions you made and the support (evidence) used to support those decisions.">

<title>Distance sampling workshop - Solution to mystery analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Distance sampling workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../Pr1/sampling.html"> 
<span class="menu-text">Sampling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr2/detnfns.html"> 
<span class="menu-text">Detection functions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr3/criticism.html"> 
<span class="menu-text">Criticism</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr4/precision.html"> 
<span class="menu-text">Precision</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr5/points.html"> 
<span class="menu-text">Points</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr6/design.html"> 
<span class="menu-text">Design</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr7/strata.html"> 
<span class="menu-text">Strata</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr8/covariates.html"> 
<span class="menu-text">Covariates</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Pr9/multipliers.html"> 
<span class="menu-text">Multipliers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../extras/extras.html"> 
<span class="menu-text">Extras</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Solution to mystery analysis</h1>
                  <div>
        <div class="description">
          Remember, the most important aspect of this exercise is the workflow that you followed, the decisions you made and the support (evidence) used to support those decisions.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Eric Rexstad </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-import" id="toc-data-import" class="nav-link active" data-scroll-target="#data-import">Data import</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory data analysis</a></li>
  <li><a href="#distance-distribution" id="toc-distance-distribution" class="nav-link" data-scroll-target="#distance-distribution">Distance distribution</a></li>
  <li><a href="#truncation-decision" id="toc-truncation-decision" class="nav-link" data-scroll-target="#truncation-decision">Truncation decision</a></li>
  <li><a href="#a-rule-of-thumb-lecture-2-slide-21" id="toc-a-rule-of-thumb-lecture-2-slide-21" class="nav-link" data-scroll-target="#a-rule-of-thumb-lecture-2-slide-21">A <em>rule of thumb</em> (Lecture 2, slide 21)</a></li>
  <li><a href="#key-function-decision" id="toc-key-function-decision" class="nav-link" data-scroll-target="#key-function-decision">Key function decision</a></li>
  <li><a href="#what-about-the-covariate" id="toc-what-about-the-covariate" class="nav-link" data-scroll-target="#what-about-the-covariate">What about the covariate?</a>
  <ul class="collapse">
  <li><a href="#aic-among-remaining-five-competitors" id="toc-aic-among-remaining-five-competitors" class="nav-link" data-scroll-target="#aic-among-remaining-five-competitors">AIC among remaining five competitors</a></li>
  </ul></li>
  <li><a href="#are-estimated-hatp_az_i-too-small" id="toc-are-estimated-hatp_az_i-too-small" class="nav-link" data-scroll-target="#are-estimated-hatp_az_i-too-small">Are estimated <span class="math inline">\(\hat{P_a}(z_i)\)</span> too small?</a></li>
  <li><a href="#estimated-detection-function" id="toc-estimated-detection-function" class="nav-link" data-scroll-target="#estimated-detection-function">Estimated detection function</a></li>
  <li><a href="#estimated-abundance" id="toc-estimated-abundance" class="nav-link" data-scroll-target="#estimated-abundance">Estimated abundance</a>
  <ul class="collapse">
  <li><a href="#best-model-half-normal-with-sex-covariate" id="toc-best-model-half-normal-with-sex-covariate" class="nav-link" data-scroll-target="#best-model-half-normal-with-sex-covariate">Best model, Half normal with sex covariate</a></li>
  <li><a href="#closest-aic-score-competitor-hazard-rate-with-sex-covariate" id="toc-closest-aic-score-competitor-hazard-rate-with-sex-covariate" class="nav-link" data-scroll-target="#closest-aic-score-competitor-hazard-rate-with-sex-covariate">Closest AIC score competitor, Hazard rate with sex covariate</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Demonstration
</div>
</div>
<div class="callout-body-container callout-body">
<p>Start-to-finish analysis of mystery data set</p>
</div>
</div>
<section id="data-import" class="level1">
<h1>Data import</h1>
<p>No drama to bring the labelled data frame into our <strong>R</strong> session.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>mydata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"mystery.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exploratory-data-analysis" class="level1">
<h1>Exploratory data analysis</h1>
<p>Number of strata, number of transects, number of detections, detections by sex</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Num strata= "</span>, <span class="fu">length</span>(<span class="fu">unique</span>(mydata<span class="sc">$</span>Region.Label)))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Num transects= "</span>, <span class="fu">length</span>(<span class="fu">unique</span>(mydata<span class="sc">$</span>Sample.Label)))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Num detects= "</span>, <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(mydata<span class="sc">$</span>distance)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mydata<span class="sc">$</span>sex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Num strata=  1
Num transects=  12
Num detects=  43 

female   male 
     4     39 </code></pre>
</div>
</div>
</section>
<section id="distance-distribution" class="level1">
<h1>Distance distribution</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(mydata<span class="sc">$</span>distance, <span class="at">main=</span><span class="st">"All detections"</span>, <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">80</span>,<span class="at">length=</span><span class="dv">17</span>),</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Perpendicular distances (m)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/disdis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vioplot</span>(mydata<span class="sc">$</span>distance[mydata<span class="sc">$</span>sex<span class="sc">==</span><span class="st">"male"</span>],</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        mydata<span class="sc">$</span>distance[mydata<span class="sc">$</span>sex<span class="sc">==</span><span class="st">"female"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/disdis-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="truncation-decision" class="level1">
<h1>Truncation decision</h1>
</section>
<section id="a-rule-of-thumb-lecture-2-slide-21" class="level1 callout-hint">
<h1>A <em>rule of thumb</em> (Lecture 2, slide 21)</h1>
<blockquote class="blockquote">
<p>Can also use estimated values of g(x) from fitted model as truncation criterion; truncate at w when g(w)=0.15</p>
</blockquote>
</section>
<p>I’m reasonably content to stick with this rule of thumb, could slice out one more data point, if I truncated at 50m.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>myunits <span class="ot">&lt;-</span> <span class="fu">convert_units</span>(<span class="st">"meter"</span>, <span class="st">"kilometer"</span>, <span class="st">"square kilometer"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>first <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">convert_units =</span> myunits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(first, <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">80</span>,<span class="at">length=</span><span class="dv">17</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Specified endpoints &gt; 79; values reset.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fl">0.15</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="dv">50</span>, <span class="at">y=</span><span class="fl">0.2</span>, <span class="st">"Pr(detect)=0.15"</span>, <span class="at">cex=</span>.<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plottrunc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>truncate <span class="ot">&lt;-</span> <span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="key-function-decision" class="level1">
<h1>Key function decision</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>unicos <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">key=</span><span class="st">"unif"</span>, <span class="at">adj=</span><span class="st">"cos"</span>, <span class="at">truncation =</span> truncate, <span class="at">convert_units =</span> myunits)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>hn <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">key=</span><span class="st">"hn"</span>, <span class="at">adj=</span><span class="st">"cos"</span>, <span class="at">truncation =</span> truncate, <span class="at">convert_units =</span> myunits)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>hr <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">key=</span><span class="st">"hr"</span>, <span class="at">adj=</span><span class="st">"cos"</span>, <span class="at">truncation =</span> truncate, <span class="at">convert_units =</span> myunits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice, adjustment terms did not survive the “within key function family” selection.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">summarize_ds_models</span>(unicos, hn, hr, <span class="at">output=</span><span class="st">"plain"</span>), <span class="at">digits=</span><span class="dv">3</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">caption=</span><span class="st">"Key function models at 50m: do they fit?"</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">column_spec</span>(<span class="dv">4</span>, <span class="at">background=</span><span class="st">"yellow"</span>, <span class="at">width=</span><span class="st">"8em"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Key function models at 50m: do they fit?</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Key function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Formula</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">C-vM $p$-value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Average detectability</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se(Average detectability)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Delta AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hn</td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.683</td>
<td style="text-align: right;">0.638</td>
<td style="text-align: right;">0.091</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">unicos</td>
<td style="text-align: left;">Uniform with cosine adjustment term of order 1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.706</td>
<td style="text-align: right;">0.624</td>
<td style="text-align: right;">0.079</td>
<td style="text-align: right;">0.452</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hr</td>
<td style="text-align: left;">Hazard-rate with cosine adjustment term of order 2</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.923</td>
<td style="text-align: right;">0.554</td>
<td style="text-align: right;">0.122</td>
<td style="text-align: right;">1.771</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
<section id="what-about-the-covariate" class="level1">
<h1>What about the covariate?</h1>
<p>Recall, there are only 4 detections of females (10% of data set). Possibly, that few detections might not have a strong influence on the parameter estimates of the detection function. Nevertheless, apply the covariate to our models at our truncation distance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>hn.sex <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">key=</span><span class="st">"hn"</span>, <span class="at">truncation =</span> truncate, <span class="at">convert_units =</span> myunits,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">formula=</span><span class="sc">~</span>sex)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>hr.sex <span class="ot">&lt;-</span> <span class="fu">ds</span>(mydata, <span class="at">key=</span><span class="st">"hr"</span>, <span class="at">truncation =</span> truncate, <span class="at">convert_units =</span> myunits,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">formula=</span><span class="sc">~</span>sex)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># unicos.sex &lt;- ds(mydata, key="unif",  truncation = truncate, convert_units = myunits,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># formula=~sex)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>😅 uniform key function does not have a scale parameter <span class="math inline">\(\sigma\)</span>, hence cannot be fitted. That reduces the number of models of interest to us. We are left with the half normal and hazard rate keys, with and without the sex covariate and the uniform cosine that cannot support a covariate.</p>
<p>Do the models with covariates fit the data? I expect they should because adding more parameters to a model ought to improve fit. The half normal and hazard already fit the data without the covariate.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hn.sex.fit <span class="ot">&lt;-</span> <span class="fu">gof_ds</span>(hn.sex, <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">chisq =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>dsgof<span class="sc">$</span>CvM<span class="sc">$</span>p</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>hr.sex.fit <span class="ot">&lt;-</span> <span class="fu">gof_ds</span>(hr.sex, <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">chisq =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>dsgof<span class="sc">$</span>CvM<span class="sc">$</span>p</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>covfits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">modname=</span><span class="fu">c</span>(<span class="st">"HN sex"</span>, <span class="st">"HR sex"</span>), </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">CvMP=</span><span class="fu">round</span>(<span class="fu">c</span>(hn.sex.fit, hr.sex.fit),<span class="dv">2</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(covfits) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width=</span><span class="cn">FALSE</span>, <span class="at">bootstrap_options=</span><span class="st">"condensed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table class="table table-condensed table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">modname</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CvMP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">HN sex</td>
<td style="text-align: right;">0.73</td>
</tr>
<tr class="even">
<td style="text-align: left;">HR sex</td>
<td style="text-align: right;">0.86</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<section id="aic-among-remaining-five-competitors" class="level2">
<h2 class="anchored" data-anchor-id="aic-among-remaining-five-competitors">AIC among remaining five competitors</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(unicos, hn, hr, hn.sex, hr.sex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       df      AIC
unicos  1 307.7994
hn      1 307.3470
hr      3 309.1185
hn.sex  2 304.1897
hr.sex  3 305.6042</code></pre>
</div>
</div>
<p>What emerges? Half normal and uniform with cosine adjustment have very similar shapes and are quite similar models. The hazard rate key without a covariate seems out of contention. What about the similarity in <span class="math inline">\(\hat{P_a}\)</span> between competing models?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">summarize_ds_models</span>(unicos, hn,hr, hn.sex, hr.sex, <span class="at">output=</span><span class="st">"plain"</span>), <span class="at">digits=</span><span class="dv">3</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">caption=</span><span class="st">"Five competing models with truncation at 50m"</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">column_spec</span>(<span class="dv">5</span>, <span class="at">background=</span><span class="st">"yellow"</span>, <span class="at">width=</span><span class="st">"8em"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Five competing models with truncation at 50m</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Key function</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Formula</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">C-vM $p$-value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Average detectability</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se(Average detectability)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Delta AIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hn.sex</td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~sex</td>
<td style="text-align: right;">0.727</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.567</td>
<td style="text-align: right;">0.092</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">hr.sex</td>
<td style="text-align: left;">Hazard-rate</td>
<td style="text-align: left;">~sex</td>
<td style="text-align: right;">0.863</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.449</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">1.415</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hn</td>
<td style="text-align: left;">Half-normal</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right;">0.683</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.638</td>
<td style="text-align: right;">0.091</td>
<td style="text-align: right;">3.157</td>
</tr>
<tr class="even">
<td style="text-align: left;">unicos</td>
<td style="text-align: left;">Uniform with cosine adjustment term of order 1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0.706</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.624</td>
<td style="text-align: right;">0.079</td>
<td style="text-align: right;">3.610</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hr</td>
<td style="text-align: left;">Hazard-rate with cosine adjustment term of order 2</td>
<td style="text-align: left;">~1</td>
<td style="text-align: right;">0.923</td>
<td style="text-align: right; width: 8em; background-color: yellow !important;">0.554</td>
<td style="text-align: right;">0.122</td>
<td style="text-align: right;">4.929</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Models without sex as a covariate estimate a larger <span class="math inline">\(\hat{P_a}\)</span>, so even with only 4 female detections, those detections do exert an influence upon the shape of the estimated detection function and consequently upon <span class="math inline">\(\hat{P_a}\)</span>.</p>
</section>
</section>
<section id="are-estimated-hatp_az_i-too-small" class="level1">
<h1>Are estimated <span class="math inline">\(\hat{P_a}(z_i)\)</span> too small?</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">p_dist_table</span>(hn.sex, <span class="at">bins=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">0.8</span>,<span class="fl">0.1</span>), <span class="at">proportion=</span><span class="cn">TRUE</span>), <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption=</span><span class="st">"Estimated detection probabilities from HN with sex covariate."</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width=</span><span class="cn">FALSE</span>, <span class="at">bootstrap_options=</span><span class="st">"condensed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table class="table table-condensed table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated detection probabilities from HN with sex covariate.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">p</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">count</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">proportion</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0 - 0.1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.1 - 0.2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.2 - 0.3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.3 - 0.4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.4 - 0.5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.5 - 0.6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.6 - 0.7</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">0.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.7 - 0.8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>This distribution violates the guideline that &lt;5% of <span class="math inline">\(\hat{P_a}\)</span> should be less than 0.2. But I’m willing to overlook that.</p>
</section>
<section id="estimated-detection-function" class="level1">
<h1>Estimated detection function</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hn.sex<span class="sc">$</span>ddf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Summary for ds object
Number of observations :  40 
Distance range         :  0  -  50 
AIC                    :  304.1897 
Optimisation           :  mrds (nlminb) 

Detection function:
 Half-normal key function 

Detection function parameters 
Scale coefficient(s): 
            estimate        se
(Intercept) 2.175139 0.3170033
sexmale     1.242131 0.4112716

                      Estimate          SE        CV
Average p            0.5671481  0.09190364 0.1620452
N in covered region 70.5283160 13.91222961 0.1972574</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hn.sex, <span class="at">main=</span><span class="st">"Half normal with sex covariate"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">add_df_covar_line</span>(hn.sex, mydata, <span class="at">lty=</span><span class="dv">1</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">c</span>(<span class="st">"Average"</span>, <span class="st">"Males"</span>, <span class="st">"Females"</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plotfn-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note the average (across sexes) detection probability curve is displaced toward the males that represent the largest proportion of the detections.</p>
</section>
<section id="estimated-abundance" class="level1">
<h1>Estimated abundance</h1>
<section id="best-model-half-normal-with-sex-covariate" class="level2">
<h2 class="anchored" data-anchor-id="best-model-half-normal-with-sex-covariate">Best model, Half normal with sex covariate</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hn.sex<span class="sc">$</span>dht<span class="sc">$</span>individual<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Label Estimate       se        cv      lcl      ucl      df
1 Total 164.5661 32.04176 0.1947045 111.3911 243.1253 38.7038</code></pre>
</div>
</div>
<p>If we wanted to employ the <em>gold standard</em> in precision estimation, we would apply a bootstrap</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>bootout <span class="ot">&lt;-</span> <span class="fu">bootdht</span>(hn.sex, <span class="at">flatfile=</span>mydata, <span class="at">summary_fun =</span> bootdht_Nhat_summarize,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nboot=</span><span class="dv">500</span>, <span class="at">convert_units =</span> myunits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Performing 500 bootstraps</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bootout<span class="sc">$</span>Nhat, <span class="at">breaks =</span> <span class="dv">20</span>, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Distribution of bootstrap replicates"</span>, <span class="at">xlab=</span><span class="st">"Abundance estimate"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>mybounds <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(bootout<span class="sc">$</span>Nhat, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>mybounds, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plotit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Confidence interval bounds from bootstrap are (127, 388), somewhat wider than the analytical confidence interval bounds specified above.</p>
</section>
<section id="closest-aic-score-competitor-hazard-rate-with-sex-covariate" class="level2">
<h2 class="anchored" data-anchor-id="closest-aic-score-competitor-hazard-rate-with-sex-covariate">Closest AIC score competitor, Hazard rate with sex covariate</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hr.sex<span class="sc">$</span>dht<span class="sc">$</span>individual<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Label Estimate      se        cv     lcl      ucl       df
1 Total 207.7639 95.9443 0.4617948 85.8307 502.9186 47.96291</code></pre>
</div>
</div>
<p>Notice the price, in terms of precision, paid for the extra parameter estimated in the hazard rate model compared to the half normal model.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Point and 95% interval estimates based upon truncation distance of 50m.</figcaption>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>